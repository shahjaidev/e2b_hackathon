# ğŸ—ï¸ Architecture Documentation

## System Overview

The CSV Analyzer AI Assistant is a full-stack application that combines AI-powered natural language understanding with secure code execution to analyze CSV data.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER INTERFACE                          â”‚
â”‚                    (React Frontend - Port 3000)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ CSV Upload   â”‚  â”‚ Chat Interfaceâ”‚  â”‚ Visualizationâ”‚        â”‚
â”‚  â”‚ Component    â”‚  â”‚   Component   â”‚  â”‚   Display    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTP/REST API
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND API SERVER                         â”‚
â”‚                    (Flask - Port 5000)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Endpoints:                                           â”‚  â”‚
â”‚  â”‚  â€¢ POST /api/upload  - Handle CSV uploads                â”‚  â”‚
â”‚  â”‚  â€¢ POST /api/chat    - Process queries                   â”‚  â”‚
â”‚  â”‚  â€¢ GET  /api/chart/* - Serve generated charts            â”‚  â”‚
â”‚  â”‚  â€¢ POST /api/session/close - Cleanup                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚
        â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gemini AI      â”‚     â”‚   E2B Sandbox    â”‚
â”‚  (2.0 Flash)     â”‚     â”‚   Environment    â”‚
â”‚                  â”‚     â”‚                  â”‚
â”‚ â€¢ Understand NL  â”‚     â”‚ â€¢ Execute Python â”‚
â”‚ â€¢ Generate Code  â”‚     â”‚ â€¢ Run Pandas     â”‚
â”‚ â€¢ Explain Resultsâ”‚     â”‚ â€¢ Create Charts  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Architecture

### Frontend (React)

```
frontend/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ index.html          # HTML template
â””â”€â”€ src/
    â”œâ”€â”€ index.js            # Application entry point
    â”œâ”€â”€ index.css           # Global styles
    â”œâ”€â”€ App.js              # Main component
    â””â”€â”€ App.css             # Component styles
```

**Key Features:**
- **File Upload**: Drag-and-drop CSV upload with validation
- **Chat Interface**: Real-time message display with typing indicators
- **Visualization Display**: Renders charts generated by Python code
- **Session Management**: Maintains state across interactions
- **Responsive Design**: Mobile-friendly, modern UI

**State Management:**
- `messages`: Array of chat messages
- `uploadedFile`: Current CSV file info
- `sessionId`: Unique session identifier
- `isLoading`: Loading state for async operations

### Backend (Flask)

```
backend/
â”œâ”€â”€ __init__.py
â””â”€â”€ app.py                  # Main Flask application
```

**API Endpoints:**

#### POST /api/upload
Uploads CSV file to E2B sandbox and analyzes structure.

**Request:**
```
Content-Type: multipart/form-data
- file: CSV file
- session_id: Session identifier
```

**Response:**
```json
{
  "success": true,
  "filename": "data.csv",
  "sandbox_path": "/home/user/data.csv",
  "columns_info": {
    "columns": ["col1", "col2"],
    "shape": [100, 5],
    "dtypes": {...}
  }
}
```

#### POST /api/chat
Processes user query and generates analysis.

**Request:**
```json
{
  "message": "Show me the distribution",
  "session_id": "session_123"
}
```

**Response:**
```json
{
  "response": "Analysis explanation...",
  "code": "import pandas as pd...",
  "charts": [{"filename": "...", "url": "..."}],
  "execution_output": ["..."],
  "has_code": true,
  "error": false
}
```

#### GET /api/chart/<filename>
Serves generated chart images.

**Response:** PNG image file

### AI Integration

#### Groq AI (groq)

**Model:** `llama-3.3-70b-versatile`

**Usage:**
1. **Code Generation**: Converts natural language queries to Python code
2. **Result Explanation**: Interprets analysis results for users

**Why Groq:**
- **Ultra-fast inference**: 10x+ faster than typical cloud APIs
- **High quality**: Llama 3.3 70B provides excellent code generation
- **Free tier**: Generous rate limits for development

**Prompt Engineering:**
```python
system_prompt = f"""You are a data analysis assistant.
CSV info: {file_info}
Generate Python code that:
1. Loads CSV from {path}
2. Performs analysis
3. Creates matplotlib visualizations
4. Saves plots
"""

groq_response = groq_client.chat.completions.create(
    model="llama-3.3-70b-versatile",
    messages=[
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": message}
    ]
)
```

**Code Extraction:**
- Parses markdown code blocks (```python)
- Validates code contains necessary imports
- Extracts executable Python code

#### E2B Code Interpreter

**Purpose:** Secure, isolated Python code execution

**Features:**
- Pre-installed data science libraries (pandas, matplotlib, numpy)
- File system access within sandbox
- No access to external network or host system
- Automatic cleanup on session end

**Workflow:**
1. Create sandbox on first request
2. Upload CSV to sandbox file system
3. Execute AI-generated Python code
4. Capture results and visualizations
5. Return base64-encoded charts

### Data Flow

```
1. User uploads CSV
   â†“
2. Frontend sends to /api/upload
   â†“
3. Backend saves locally and uploads to E2B sandbox
   â†“
4. Pandas analyzes CSV structure
   â†“
5. Returns column info to frontend
   â†“
6. User asks question
   â†“
7. Frontend sends to /api/chat
   â†“
8. Backend sends question + context to Groq
   â†“
9. Groq generates Python code (Llama 3.3)
   â†“
10. Backend executes code in E2B sandbox
    â†“
11. E2B returns results + charts
    â†“
12. Backend saves charts locally
    â†“
13. Groq explains results
    â†“
14. Frontend displays explanation + charts
```

## Security Considerations

### Sandboxed Execution
- All code runs in isolated E2B containers
- No access to host filesystem or network
- Automatic timeout and resource limits
- Clean slate for each session

### Input Validation
- CSV file type validation
- File size limits
- SQL injection prevention (no direct SQL)
- Code injection prevention (AI-generated only)

### API Security
- CORS enabled for frontend-only access
- Session-based sandbox isolation
- No sensitive data in responses
- Environment variables for secrets

## Scalability

### Current Limitations
- Single-threaded Flask (development mode)
- In-memory session storage
- Local file storage

### Production Improvements
- Use production WSGI server (Gunicorn/uWSGI)
- Redis for session management
- S3/Cloud Storage for files
- Database for analytics
- Load balancer for multiple instances
- Rate limiting and authentication

## Error Handling

### Frontend
- File upload validation
- Network error handling
- User-friendly error messages
- Loading states

### Backend
- Try-catch blocks for all operations
- Proper HTTP status codes
- Error logging
- Graceful degradation

### E2B Sandbox
- Execution timeout handling
- Code error capture
- Resource limit handling
- Automatic cleanup

## Performance Optimization

### Current
- Efficient pandas operations
- Chart caching
- Minimal data transfer
- Code result reuse

### Future Improvements
- Query caching
- Chart thumbnail generation
- Async processing
- WebSocket for real-time updates
- Progressive chart loading

## Dependencies

### Backend
```
flask==3.0.0              # Web framework
flask-cors==4.0.0         # CORS support
python-dotenv==1.0.0      # Environment management
e2b-code-interpreter==0.0.10  # Code execution
groq==0.11.0              # Groq AI (Llama 3.3)
pandas==2.1.4             # Data analysis
```

### Frontend
```
react==18.2.0             # UI framework
axios==1.6.2              # HTTP client
react-scripts==5.0.1      # Build tools
```

## Development vs Production

| Aspect | Development | Production |
|--------|-------------|------------|
| Flask | Debug mode | Gunicorn/uWSGI |
| CORS | Allow all | Specific origins |
| File Storage | Local disk | Cloud storage |
| Sessions | In-memory | Redis/Database |
| Logging | Console | File/Service |
| HTTPS | Optional | Required |
| Auth | None | OAuth/JWT |

## Monitoring & Logging

### Logs to Implement
- API request/response times
- E2B execution metrics
- Groq API usage
- Error rates
- User activity

### Metrics to Track
- Average query response time
- Code execution success rate
- Chart generation time
- API quota usage (Groq rate limits)
- Session duration

## Testing Strategy

### Unit Tests
- API endpoint testing
- Code extraction logic
- Error handling
- File upload validation

### Integration Tests
- E2B sandbox integration
- Gemini API integration
- End-to-end workflows

### UI Tests
- Component rendering
- File upload flow
- Chat interaction
- Chart display

---

This architecture provides a solid foundation for the CSV Analyzer AI Assistant while maintaining security, scalability, and maintainability.

